<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Revenue | CCNY Beavers</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    /* BUTTON STYLES */
    .btn-sm { padding: 5px 10px; font-size: 0.85em; border: none; border-radius: 4px; cursor: pointer; color: white; transition: background 0.2s;}
    .btn-success { background-color: #28a745; }
    .btn-danger { background-color: #dc3545; }
    .btn-success:hover { background-color: #218838; }
    .btn-danger:hover { background-color: #c82333; }
    
    /* BADGE STYLES */
    .badge-pending { background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;}
    
    /* LAYOUT */
    .dashboard-section { margin-bottom: 40px; }

    /* ALERT MESSAGE STYLES (The Fix) */
    .alert { padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }
    .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeeba; }
    .alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <div class="logo"><h1>CCNY Beavers</h1><p>Revenue Dashboard</p></div>
      <nav>
        <ul>
          <li><a href="{{ url_for('index') }}">Home</a></li>
          <li><a href="{{ url_for('event_list') }}">Events</a></li>
          <li><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="margin-bottom: 20px;">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="section-header">
      <h2>{{ stats.role }} Dashboard</h2>
      {% if is_admin %}
        <p class="text-muted">Viewing global 7% platform fee revenue from all organizations.</p>
      {% else %}
        <p class="text-muted">Viewing your event revenue (Total Sales minus 7% Platform Fee).</p>
      {% endif %}
    </div>

    <div class="stats-grid">
      <div class="stat-card gold">
        <h3>{% if is_admin %}Platform Fees{% else %}Net Revenue{% endif %}</h3>
        <div class="stat-value">{{ stats.total_revenue }}</div>
      </div>
      <div class="stat-card">
        <h3>Tickets Sold</h3>
        <div class="stat-value">{{ stats.total_tickets_sold }}</div>
      </div>
      <div class="stat-card">
        <h3>Events Tracked</h3>
        <div class="stat-value">{{ stats.events_hosted }}</div>
      </div>
    </div>

    <div class="dashboard-section">
        <h3>⚠️ Pending Orders (Pay at Door)</h3>
        <p class="text-muted">These students have registered but not yet paid. Mark them as paid when they arrive.</p>
        
        <div class="table-container">
            <table>
            <thead>
                <tr>
                <th>Student Name</th>
                <th>Student ID</th>
                <th>Event</th>
                <th>Amount Due</th>
                <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in pending_orders %}
                <tr>
                <td>{{ order.full_name }}</td>
                <td>{{ order.student_id }}</td>
                <td>{{ order.title }}</td>
                <td>${{ "{:,.2f}".format(order.amount_cents / 100) }} <span class="badge-pending">Unpaid</span></td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <form action="{{ url_for('update_order_status', order_id=order.order_id, action='pay') }}" method="POST" style="display:inline;">
                            <button type="submit" class="btn-sm btn-success" onclick="return confirm('Confirm payment received?');">Mark Paid</button>
                        </form>
                        
                        <form action="{{ url_for('update_order_status', order_id=order.order_id, action='cancel') }}" method="POST" style="display:inline;">
                            <button type="submit" class="btn-sm btn-danger" onclick="return confirm('Are you sure you want to cancel this ticket?');">Cancel</button>
                        </form>
                    </div>
                </td>
                </tr>
                {% endfor %}
                {% if not pending_orders %}
                <tr><td colspan="5" style="text-align:center; color: #888; padding: 20px;">No pending orders found.</td></tr>
                {% endif %}
            </tbody>
            </table>
        </div>
    </div>

    <div class="dashboard-section">
        <h3>✅ Realized Revenue Reports</h3>
        <div class="table-container">
        <table>
            <thead>
            <tr>
                <th>Event Name</th>
                {% if is_admin %}<th>Organization</th>{% endif %}
                <th>Date</th>
                <th>Tickets Sold</th>
                <th>{% if is_admin %}Fee Earned ($){% else %}Net Earnings ($){% endif %}</th>
            </tr>
            </thead>
            <tbody>
            {% for row in event_rows %}
            <tr>
                <td>{{ row.title }}</td>
                {% if is_admin %}<td>{{ row.org_name }}</td>{% endif %}
                <td>{{ row.starts_at.strftime('%b %d, %Y') }}</td>
                <td>{{ row.tickets_sold }}</td>
                <td style="font-weight: bold; color: green;">${{ "{:,.2f}".format(row.revenue_cents / 100) }}</td>
            </tr>
            {% endfor %}
            {% if not event_rows %}
            <tr><td colspan="5">No data available.</td></tr>
            {% endif %}
            </tbody>
        </table>
        </div>
    </div>
  </main>
  <footer><p>City College of New York • Event System</p></footer>
</body>
</html>